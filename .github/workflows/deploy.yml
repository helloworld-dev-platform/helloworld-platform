name: backend_deploy

# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted]
    env:
      NGROK_TOKEN:        ${{ secrets.NGROK_TOKEN }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 1) ë¹Œë“œ & ë°°í¬: ì˜¤ë¥˜ ë‚˜ë„ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ë‹¤ìŒ ìŠ¤í…ì—ì„œ íŒë‹¨
      - name: Build & start containers
        id: deploy-step
        continue-on-error: true
        run: |
          docker-compose up -d --build

      # --------------------------------------------------------
      # 2) ë¡¤ë°± (ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì´ì „ ì´ë¯¸ì§€ë¡œ ë³µêµ¬)
      - name: Rollback to last successful version
        if: ${{ steps.deploy-step.outcome != 'success' }}
        run: |
          echo "ğŸš¨ Deployment failed â€“ rolling back to last known-good state"
          docker-compose down
          docker-compose up -d --no-build
          exit 1

      # --------------------------------------------------------
      # 3) ngrok í„°ë„ë§ (ë°°í¬ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤)
      - name: Start ngrok tunnels
        id: ngrok
        run: |
          ./ngrok authtoken $NGROK_TOKEN
          nohup ./ngrok http 8081 --region=ap --log=stdout > ngrok-api.log &
          nohup ./ngrok http 8091 --region=ap --log=stdout > ngrok-ws.log &
          sleep 5

          # ngrok ë¡œì»¬ APIì—ì„œ í„°ë„ ì •ë³´ íŒŒì‹±
          DATA=$(curl -s http://127.0.0.1:4040/api/tunnels)
          API_URL=$(echo "$DATA" \
            | jq -r '.tunnels[] | select(.config.addr=="http://localhost:8081") .public_url')
          WS_URL=$(echo "$DATA" \
            | jq -r '.tunnels[] | select(.config.addr=="http://localhost:8091") .public_url')

          # GitHub Actions Outputs ì„¤ì •
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "ws_url=$WS_URL"   >> $GITHUB_OUTPUT

      - name: Show public URLs
        run: |
          echo "REST API ğŸ‘‰ ${{ steps.ngrok.outputs.api_url }}"
          echo "WebSocket ğŸ‘‰ ${{ steps.ngrok.outputs.ws_url }}"

      # --------------------------------------------------------
      # 4) ë°°í¬ ì„±ê³µ ì‹œ Discord ì•Œë¦¼
      - name: Discord Notification (Success)
        if: ${{ success() }}
        run: |
          curl -H "Content-Type: application/json" -X POST "${{ env.DISCORD_WEBHOOK_URL }}" \
            -d "{\"content\":\"âœ… ë°°í¬ ì„±ê³µ!\nâ€¢ REST API: ${{ steps.ngrok.outputs.api_url }}\nâ€¢ WebSocket: ${{ steps.ngrok.outputs.ws_url }}\"}"

      # 5) ë°°í¬ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (ë¡¤ë°± ì§í›„ ì‹¤í–‰)
      - name: Discord Notification (Failure)
        if: ${{ failure() }}
        run: |
          curl -H "Content-Type: application/json" -X POST "${{ env.DISCORD_WEBHOOK_URL }}" \
            -d "{\"content\":\"âŒ ë°°í¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡¤ë°±ì´ ì™„ë£Œë˜ì—ˆì–´ìš”.\"}"
