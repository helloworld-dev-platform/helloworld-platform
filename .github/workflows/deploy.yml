name: Deploy to NCP Server

# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: docker.io
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_NAMES: "backend-server,websocket-server"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 1. ë¡¤ë°±ì„ ìœ„í•œ ì´ì „ ë²„ì „ ë°±ì—… (Docker Hubì— :previous íƒœê·¸ë¡œ ì €ì¥)
      - name: Backup latest to previous tag
        shell: bash
        continue-on-error: true # ì²« ë°°í¬ ì‹œ latest ì´ë¯¸ì§€ê°€ ì—†ì–´ ì‹¤íŒ¨í•˜ë¯€ë¡œ ì˜¤ë¥˜ë¥¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
        run: |
          for imageName in $(echo $IMAGE_NAMES | sed "s/,/ /g")
          do
            echo "Backing up latest version of $imageName to previous tag..."
            docker pull ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:latest || true
            docker tag ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:latest ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:previous || true
            docker push ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:previous || true
          done

      # --------------------------------------------------------
      # 2) Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (CIê³¼ì •)
      - name: Build, Push backend-server images with cache
        uses: docker/build-push-action@v5
        with:
          context: ./backend-api
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/backend-server:latest
          cache-from: type=gha,scope=${{ github.workflow }}-${{ github.job }}-backend-server
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ github.job }}-backend-server


      - name: Build and push websocket-server image with cache
        uses: docker/build-push-action@v5
        with:
          context: ./websocket-server
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/websocket-server:latest
          cache-from: type=gha,scope=${{ github.workflow }}-${{ github.job }}-websocket-server
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ github.job }}-websocket-server
      
      # --------------------------------------------------------
      # 3) ë°°í¬ ì „, ì‹œí¬ë¦¿ ê°’ ìœ íš¨ì„± ê²€ì‚¬
      - name: Verify Secrets
        shell: bash
        run: |
          if [ -z "${{ secrets.JWT_SECRET_KEY }}" ]; then
            echo "âŒ ERROR: JWT_SECRET_KEY secret is not set or empty!"
            exit 1
          else
            echo "âœ… SUCCESS: JWT_SECRET_KEY secret is loaded."
          fi
          if [ -z "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
            echo "âŒ ERROR: GOOGLE_CLIENT_ID secret is not set or empty!"
            exit 1
          else
            echo "âœ… SUCCESS: GOOGLE_CLIENT_ID secret is loaded."
          fi
          if [ -z "${{ secrets.GOOGLE_CLIENT_SECRET }}" ]; then
            echo "âŒ ERROR: GOOGLE_CLIENT_SECRET secret is not set or empty!"
            exit 1
          else
            echo "âœ… SUCCESS: GOOGLE_CLIENT_SECRET secret is loaded."
          fi
          if [ -z "${{ secrets.POSTGRES_DB }}" ]; then
            echo "âŒ ERROR: POSTGRES_DB secret is not set or empty!"
            exit 1
          else
            echo "âœ… SUCCESS: POSTGRES_DB secret is loaded."
          fi
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then
            echo "âŒ ERROR: POSTGRES_PASSWORD secret is not set or empty!"
            exit 1
          else
            echo "âœ… SUCCESS: POSTGRES_PASSWORD secret is loaded."
          fi
          if [ -z "${{ secrets.POSTGRES_USER }}" ]; then
            echo "âŒ ERROR: POSTGRES_USER secret is not set or empty!"
            exit 1
          else
            echo "âœ… SUCCESS: POSTGRES_USER secret is loaded."
          fi

      # --------------------------------------------------------
      # 4) NCP ì„œë²„ ì ‘ì†í•˜ì—¬ ë°°í¬(CDê³¼ì •)
      - name: Deploy to NCP Server
        id: deploy_latest
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_SERVER_HOST }}
          username: ${{ secrets.NCP_SERVER_USERNAME }}
          key: ${{ secrets.NCP_SSH_PRIVATE_KEY }}
          script: |
            set -e  # ìŠ¤í¬ë¦½íŠ¸ ë‚´ì˜ ëª…ë ¹ì–´ ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            cd ~/dev/helloworld-platform
            
            # docker-compose.yml íŒŒì¼ì„ ìµœì‹ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            echo "--- Pulling latest source code from main branch ---"
            git pull origin main
            
            # .env íŒŒì¼ì„ í•œë²ˆì— ìƒì„±
            echo "--- Creating .env file on server ---"
            cat << EOF > .env
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            IMAGE_TAG=latest
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            EOF
            
            echo "--- Pulling latest images ---"
            docker compose pull
            echo "--- Starting containers ---"
            docker compose up -d
            echo "--- Pruning unused images ---"
            docker image prune -f

      # --------------------------------------------------------
      # 5. ë°°í¬ ì‹¤íŒ¨ ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
      - name: Rollback to previous version on failure
        if: failure() && steps.deploy_latest.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_SERVER_HOST }}
          username: ${{ secrets.NCP_SERVER_USERNAME }}
          key: ${{ secrets.NCP_SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "Deployment failed. Rolling back to previous version..."
            cd ~/dev/helloworld-platform
            
            sed -i 's/^IMAGE_TAG=.*/IMAGE_TAG=previous/' .env
            
            docker compose pull
            docker compose up -d

      # --------------------------------------------------------
      # 6) ë°°í¬ ì„±ê³µ ì‹œ Discord ì•Œë¦¼
      - name: Discord Notification (Success)
        if: ${{ success() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âœ… ë°°í¬ ì„±ê³µ!"
          description: |
            â€¢ REST API: http://${{ secrets.NCP_SERVER_HOST }}:8081
            â€¢ WebSocket: http://${{ secrets.NCP_SERVER_HOST }}:8091
          color: 65280 #green
          username: Deploy Bot

      # --------------------------------------------------------
      # 7) ë°°í¬ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (ë¡¤ë°± ì§í›„ ì‹¤í–‰)
      - name: Discord Notification (Failure)
        if: ${{ failure() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ğŸš¨ ë°°í¬ì‹¤íŒ¨"
          description: "NCP ì„œë²„ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          color: 16711680 #Red
          username: Deploy Bot