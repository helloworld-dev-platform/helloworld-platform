name: backend_deploy

# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [ self-hosted ]
    env:
      REGISTRY: docker.io
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_NAMES: "backend-server,websocket-server"
      NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 1) ë¡¤ë°±ì„ ìœ„í•œ ì´ì „ ë²„ì „(latest) ë°±ì—…
      - name: Tag previous versions for rollback
        shell: powershell
        run: |
          foreach ($imageName in "${{ env.IMAGE_NAMES }}".Split(',')) {
              Write-Host "Attempting to back up latest version of $imageName..
              # docker pull ëª…ë ¹ì–´ì˜ ì‹¤íŒ¨ë¥¼ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬
              try {
              docker pull ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:latest -ErrorAction Stop
              # pullì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì•„ë˜ ë¡œì§ ì‹¤í–‰
              Write-Host "Pull successful. Tagging and pushing 'previous' version of $imageName
              docker tag ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:latest ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:previous
              if ($LASTEXITCODE -ne 0) {
              # tag ì‹¤íŒ¨ì‹œ, ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              throw "Failed to tag 'previous' for $imageName."
          
              docker push ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:previous
              if ($LASTEXITCODE -ne 0) {
              # push ì‹¤íŒ¨ì‹œ, ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              throw "Failed to push 'previous' for $imageName."
            }
            } catch {
              # docker pullì´ ì‹¤íŒ¨í•˜ë©´ (ì²« ë°°í¬ ë“±) ì´ ë¸”ë¡ì´ ì‹¤í–‰ë¨
              Write-Warning "Could not pull 'latest' for $imageName. This is expected on the first deployment. Skipping backup."
            }
          }

      # --------------------------------------------------------
      # 2) ìƒˆ ë²„ì „ ë¹Œë“œ & í‘¸ì‹œ & ë°°í¬
      - name: Build, Push and Deploy new versions
        id: deploy-step
        continue-on-error: true
        shell: powershell
        run: |
          docker compose build
          
          # ë¹Œë“œëœ ëª¨ë“  ì´ë¯¸ì§€ì— ëŒ€í•´ íƒœê·¸ ì§€ì • ë° í‘¸ì‹œ ë°˜ë³µ
          foreach ($imageName in "${{ env.IMAGE_NAMES }}".Split(',')) {
            Write-Host "Tagging and pushing image: $imageName"
            $imageFullName = "${{ env.DOCKER_USERNAME }}/$imageName"
            $registryFullName = "${{ env.REGISTRY }}/$imageFullName"
          
            docker tag $imageFullName:latest $registryFullName:latest
            docker tag $imageFullName:latest $registryFullName:${{ github.sha }}
          
            docker push $registryFullName:latest
            docker push $registryFullName:${{ github.sha }}
          }
          
          docker compose up -d

      # --------------------------------------------------------
      # 3) ë¡¤ë°± (ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì´ì „ ì´ë¯¸ì§€ë¡œ ë³µêµ¬)
      - name: Rollback to last successful version
        if: ${{ steps.deploy-step.outcome != 'success' }}
        shell: powershell
        run: |
          Write-Host "Deployment failed - rolling back to last known good state"
          $env:IMAGE_TAG="previous"
          docker compose up -d
          exit 1

      # --------------------------------------------------------
      # 4) ngrok í„°ë„ë§ (ë°°í¬ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤)
      - name: Setup ngrok with cache
        id: setup-ngrok
        uses: actions/cache@v4
        with:
          path: ngrok.exe #ngrokì„¤ì¹˜íŒŒì¼ ìºì‹±
          key: ${{ runner.os }}-ngrok-v3 #ìºì‹œ ì‹ë³„ ê³ ìœ í‚¤

      - name: Download and start ngrok
        id: ngrok
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          
          # ngrok ë‹¤ìš´ë¡œë“œ
          if ($env:CACHE_HIT -ne 'true') {
            Write-Host "ngrok not found in cache. Downloading..."
            Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
            Expand-Archive ngrok.zip -DestinationPath .
          } else {
            Write-Host "ngrok restored from cache."
          }
          
          #ngrok.yml íŒŒì¼ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          $ngrokTemplatePath = "${{ github.workspace }}/ngrok.yml"
          $ngrokConfigPath = "ngrok-config.yml" 
          
          $content = Get-Content $ngrokTemplatePath
          $content = $content -replace '\${NGROK_TOKEN}', "$env:NGROK_TOKEN"
          Set-Content -Path $ngrokConfigPath -Value $content
          
          # ngrok.ymlì„ configë¡œ í„°ë„ ì‹œì‘
          Start-Process -FilePath .\ngrok.exe -ArgumentList "start --all --config $ngrokConfigPath --log=stdout" -RedirectStandardOutput ngrok.log -NoNewWindow
          
          # ngrok API ì¤€ë¹„ë ë•Œê¹Œì§€ 5íšŒ ì¬ì‹œë„
          Write-Host "Waiting for ngrok API to be ready..."
          $maxRetries = 5
          $retryDelay = 3
          for ($i=0; $i -lt $maxRetries; $i++) {
              try {
                  Start-Sleep -Seconds $retryDelay
                  $data = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels -ErrorAction Stop
                  if ($data.tunnels.Count -gt 0) {
                      Write-Host "ngrok API is ready."
                      break
                  }
              } catch {
                  Write-Host "ngrok API not ready, retrying... ($($i+1)/$maxRetries)"
              }
              if ($i -eq ($maxRetries - 1)) {
                  Write-Error "Failed to connect to ngrok API after $maxRetries retries."
                  exit 1
              }
          }
          
          # í¼ë¸”ë¦­URL ì¡°íšŒ
          $api = ($data.tunnels | Where-Object { $_.name -eq "api" }).public_url
          $ws  = ($data.tunnels | Where-Object { $_.name -eq "ws" }).public_url
          
          # GitHub Actions Outputs ì„¤ì •
          "api_url=$api" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "ws_url=$ws"   | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Show public URLs
        shell: powershell
        run: |
          Write-Host "REST API    ${{ steps.ngrok.outputs.api_url }}"
          Write-Host "WebSocket   ${{ steps.ngrok.outputs.ws_url }}"

      # --------------------------------------------------------
      # 5) ë°°í¬ ì„±ê³µ ì‹œ Discord ì•Œë¦¼
      - name: Discord Notification (Success)
        if: ${{ success() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âœ… ë°°í¬ ì„±ê³µ!"
          description: |
            â€¢ REST API: ${{ steps.ngrok.outputs.api_url }}
            â€¢ WebSocket: ${{ steps.ngrok.outputs.ws_url }}
          color: 65280 #green
          username: Deploy Bot
      # --------------------------------------------------------
      # 6) ë°°í¬ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (ë¡¤ë°± ì§í›„ ì‹¤í–‰)
      - name: Discord Notification (Failure)
        if: ${{ failure() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ğŸš¨ ë°°í¬ì‹¤íŒ¨"
          color: 16711680 #Red
          username: Deploy Bot