name: Deploy to Public API Server

# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: docker.io
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_NAMES: "backend-server,websocket-server"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ë°©í™”ë²½ ì œì–´ìš© AWS ê¶Œí•œ ì„¤ì •
      - name: Configure AWS Credentials for Firewall
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_CICD_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_CICD_SECRET_KEY }}
          aws-region: ap-northeast-2

      # í˜„ì¬ GitHub ëŸ¬ë„ˆì˜ IP ê°€ì ¸ì˜¤ê¸°
      - name: Get Runner IP
        id: ip
        run: echo "ip=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      # ë³´ì•ˆ ê·¸ë£¹ 2ê°œ ë¬¸ ì—´ê¸°
      - name: Whitelist Runner IP
        run: |
          for sg_id in "${{ secrets.AWS_SG_ID_API }}" "${{ secrets.AWS_SG_ID_WS }}"
          do
            echo "Opening port 22 for SG $sg_id"
            aws ec2 authorize-security-group-ingress \
              --group-id $sg_id \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.ip }}/32 || true
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 1. ë¡¤ë°±ì„ ìœ„í•œ ì´ì „ ë²„ì „ ë°±ì—… (Docker Hubì— :previous íƒœê·¸ë¡œ ì €ì¥)
      - name: Backup latest to previous tag
        shell: bash
        continue-on-error: true # ì²« ë°°í¬ ì‹œ latest ì´ë¯¸ì§€ê°€ ì—†ì–´ ì‹¤íŒ¨í•˜ë¯€ë¡œ ì˜¤ë¥˜ë¥¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
        run: |
          for imageName in $(echo $IMAGE_NAMES | sed "s/,/ /g")
          do
            echo "Backing up latest version of $imageName..."
            docker pull ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:latest || true
            docker tag ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:latest ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:previous || true
            docker push ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/$imageName:previous || true
          done

      # --------------------------------------------------------
      # 2) Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ë°±ì—”ë“œ & ì›¹ì†Œì¼“)
      - name: Build and push backend-server
        uses: docker/build-push-action@v5
        with:
          context: ./backend-api
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/backend-server:latest
          cache-from: type=gha,scope=${{ github.workflow }}-backend
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-backend


      - name: Build and push websocket-server
        uses: docker/build-push-action@v5
        with:
          context: ./websocket-server
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/websocket-server:latest
          cache-from: type=gha,scope=${{ github.workflow }}-websocket
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-websocket
      
      # --------------------------------------------------------
      # 3. AWS EC2 ì„œë²„ ì ‘ì† ë° ë°°í¬
      - name: Deploy to AWS EC2
        id: deploy_latest
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USERNAME }}
          key: ${{ secrets.API_SSH_KEY }}
          script: |
            set -e
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ë³¸ì¸ì˜ ì‹¤ì œ ê²½ë¡œ í™•ì¸)
            cd ~/dev/helloworld-platform 
            
            echo "--- Git Reset & Pulling ---"
            git checkout .
            git clean -fd
            git pull origin main
            
            echo "--- Generating .env file ---"
            cat << EOF > .env
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            IMAGE_TAG=latest
            
            # [DB & Cache]
            SPRING_DATASOURCE_URL=${{ secrets.RDS_ENDPOINT }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            SPRING_REDIS_HOST=${{ secrets.REDIS_HOST }}
            SPRING_REDIS_PORT=6379
            REDIS_USER=${{ secrets.REDIS_USER }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            
            # [AWS SDK Credentials]
            AWS_REGION=${{ secrets.AWS_REGION }}
            
            # [S3 & SQS for Grading]
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            SQS_QUEUE_URL=${{ secrets.SQS_QUEUE_URL }}
            
            # [Auth & OAuth]
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            EOF
            
            echo "--- Docker Compose Deploy ---"
            # ê°œë°œìš© ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ ì§€ì • ì‹¤í–‰
            docker compose -f docker-compose.dev.yml pull
            docker compose -f docker-compose.dev.yml up -d
            
            echo "--- Cleanup ---"
            docker image prune -f      

      # ë³´ì•ˆ ê·¸ë£¹ ë¬¸ ë‹«ê¸° (ì‹¤íŒ¨í•´ë„ ë¬´ì¡°ê±´ ì‹¤í–‰!)
      - name: Revoke Runner IP
        if: always()
        run: |
          for sg_id in "${{ secrets.AWS_SG_ID_API }}" "${{ secrets.AWS_SG_ID_WS }}"
          do
            echo "Closing port 22 for SG $sg_id"
            aws ec2 revoke-security-group-ingress \
              --group-id $sg_id \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.ip }}/32 || true
          done

      # --------------------------------------------------------
      # 4. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± (ì´ì „ ì´ë¯¸ì§€ ì‚¬ìš©)
      - name: Rollback on failure
        if: failure() && steps.deploy_latest.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USERNAME }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          script: |
            cd ~/dev/helloworld-platform
            echo "Deployment failed. Rolling back to :previous version..."
            sed -i 's/^IMAGE_TAG=.*/IMAGE_TAG=previous/' .env
            docker compose -f docker-compose.dev.yml pull
            docker compose -f docker-compose.dev.yml up -d

      # --------------------------------------------------------
      # 5) ë°°í¬ ì„±ê³µ ì‹œ Discord ì•Œë¦¼
      - name: Discord Notification (Success)
        if: ${{ success() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "âœ… AWS Dev ì„œë²„ ë°°í¬ ì„±ê³µ!"
          description: |
            **Status**: ${{ job.status }}
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            ğŸ”— **API**: https://helloworld-coding-platform.com
            ğŸ”— **WebSocket**: wss://helloworld-coding-platform.com/ws
          color: 65280 #green
          username: Deploy Bot

      # --------------------------------------------------------
      # 6) ë°°í¬ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (ë¡¤ë°± ì§í›„ ì‹¤í–‰)
      - name: Discord Notification (Failure)
        if: ${{ failure() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ğŸš¨ AWS Dev ë°°í¬ ì‹¤íŒ¨"
          description: |
            **Status**: Failed
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
          color: 16711680 #Red
          username: Deploy Bot